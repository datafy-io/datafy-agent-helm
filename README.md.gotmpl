{{ template "chart.header" . }}
{{ template "chart.badgesSection" . }}
{{ template "chart.description" . }}

This guide will walk you through the process of adding the Datafy Helm repository and installing the `datafy-agent` on your Kubernetes cluster using Helm.

---

## Features
- Dual mode: sensor / autoscaler
- Optional bundled aws-ebs-csi-driver
- CSI proxy support
- Configurable env, resources, tolerations, affinity
- Pluggable token secret
- Validations (CSI presence, mode logic)
- Autogenerated values documentation (helm-docs)

---

## Quick Start (Sensor)
```bash
helm repo add datafyio https://helm.datafy.io/datafy-agent
helm repo update
helm install datafy-agent datafyio/datafy-agent \
  --namespace datafy --create-namespace \
  --set agent.mode="sensor" \
  --set agent.token=$DATAFY_TOKEN
```

## Quick Start (Autoscaler + Existing CSI)
```bash
helm install datafy-agent datafyio/datafy-agent \
  -n datafy --create-namespace \
  --set agent.mode="autoscaler" \
  --set agent.token=$DATAFY_TOKEN \
  --set awsEbsCsiDriver.enabled=false \
  --set ebsCsiProxy.enabled=true
```

## Modes Matrix
| agent.mode   | Core sidecar | Needs CSI Driver | Uses CSI Proxy | Notes |
|--------------|--------------|------------------|----------------|-------|
| sensor       | No           | No               | No             | Minimal footprint |
| autoscaler   | Yes (core)   | Recommended      | Optional       | Scaling logic enabled |

---

## Installation Guide
### 1. Add Repo
```bash
helm repo add datafyio https://helm.datafy.io/datafy-agent
helm repo update
```

### 2. Install
```bash
helm install datafy-agent datafyio/datafy-agent --namespace <namespace> --create-namespace \
  --set agent.mode="sensor/autoscaler" \
  --set agent.token=<your_token> \
  --set agent.image.tag=<image_tag>
```

### 3. Enable / Disable aws-ebs-csi-driver
```bash
helm install datafy-agent datafyio/datafy-agent \
  --set awsEbsCsiDriver.enabled=true
```

Override subchart values:
```yaml
aws-ebs-csi-driver:
  controller:
    replicaCount: 2
```

### 4. Optional Customizations
Examples:
```yaml
agent:
  mode: autoscaler
  env:
    LOG_LEVEL: info
image:
  imagePullSecrets:
    - myRegistrySecret
ebsCsiProxy:
  namespace: kube-system
```

### 5. Verify
```bash
kubectl get pods -n <namespace> -l app.kubernetes.io/instance=datafy-agent
```

---

## Upgrade
```bash
helm repo update
helm upgrade datafy-agent datafyio/datafy-agent -n <namespace> --reuse-values
```
Switch mode (forces restart):
```bash
helm upgrade datafy-agent datafyio/datafy-agent -n <ns> --set agent.mode=autoscaler
```

Rollback:
```bash
helm rollback datafy-agent 1 -n <ns>
```

---

## Uninstall
```bash
helm uninstall datafy-agent --namespace <namespace>
```

---

## Highlighted Values (Common)
| Key | Description | Example |
|-----|-------------|---------|
| agent.mode | Deployment mode (sensor/autoscaler) | autoscaler |
| agent.token | Authentication token (secret or inline) | abc123 |
| awsEbsCsiDriver.enabled | Install bundled CSI driver | true |
| ebsCsiProxy.enabled | Use proxy if driver already present | true |
| agent.env | Extra environment variables | LOG_LEVEL=info |
| agent.image.tag | Image tag override | v1.2.3 |

---

## Troubleshooting
| Symptom | Cause | Resolution |
|---------|-------|-----------|
| CSI validation failure | Driver missing while proxy enabled | Install driver or disable proxy |
| Pods Pending | Taints not tolerated | Set agent.tolerations |
| CrashLoop (token) | Token secret absent | Create secret or set agent.token |
| Mode switch not applied | Old pods running | kubectl rollout restart ds/datafy-agent |

---

## Security Recommendations
- Set runAsNonRoot, drop ALL capabilities
- Prefer readOnlyRootFilesystem
- Limit hostNetwork/hostPID unless required
- Scope token secret to namespace only
- Use imagePullSecrets for private registries

---

## Development
Lint and template:
```bash
helm lint .
helm template test .
```
Generate docs:
```bash
helm-docs
```

---

## Parameters
{{ template "chart.valuesSection" . }}

## Notes
Generated by helm-docs. Do not edit the Parameters table manually.

---
_This README is rendered from README.md.gotmpl via helm-docs._
