name: Release Chart

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write

jobs:
  version:
    name: Bump version and tag
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      new_version: ${{ steps.tag_version.outputs.new_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: "datafy-agent-"
          default_bump: patch
          pre_release_branches: false
          dry_run: true

      - name: Show version info
        run: |
          echo "Tag created: ${{ steps.tag_version.outputs.new_tag }}"
          echo "Version: ${{ steps.tag_version.outputs.new_version }}"

  release:
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Management Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}

      - name: Add datafyio-s3 Helm repository
        run: |
          helm plugin install https://github.com/hypnoglow/helm-s3.git
          helm repo add datafyio-s3 s3://helm.datafy.io/datafy-agent

      - name: Update Helm dependency
        run: |
          helm dependency update

      - name: Push Helm chart
        run: |
          CHART_VERSION="${{ needs.version.outputs.new_version }}"
          EBS_CSI_DRIVER_VERSION=$(yq '.dependencies[] | select(.name == "aws-ebs-csi-driver") | .version' Chart.yaml)

          echo "ðŸ“¦ Packaging base chart..."
          helm package --version "${CHART_VERSION}" .

          echo "ðŸ“¦ Packaging with EBS CSI dependency version..."
          helm package --version "${CHART_VERSION}+ebscsi.${EBS_CSI_DRIVER_VERSION}" .

          # echo "ðŸš€ Pushing both charts to S3 repo..."
          # helm s3 push "datafy-agent-${CHART_VERSION}.tgz" datafyio-s3 --relative
          # helm s3 push "datafy-agent-${CHART_VERSION}+ebscsi.${EBS_CSI_DRIVER_VERSION}.tgz" datafyio-s3 --relative
