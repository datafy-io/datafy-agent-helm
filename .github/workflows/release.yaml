name: Release Chart

on:
  push:
  # workflow_dispatch:
  # workflow_call:
  #   secrets:
  #     PRODUCTION_AWS_ROLE_ARN:
  #       required: true

permissions:
  id-token: write
  contents: write  # Grant write access to the repository contents

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      HELM_VERSION: ${{ steps.tag_version.outputs.new_tag }}
      CURRENT_VERSION: ${{ steps.current_version.outputs.HELM_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        uses: mathieudutour/github-tag-action@v6.2
        id: tag_version
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} 
          tag_prefix: "datafy-agent-" 
          pre_release_branches: false
          dry_run: true
          default_bump: patch 

  build:
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update Chart.yaml (only if bumped)
        run: |
          VER="${{ needs.version.tag_version.outputs.new_tag }}"
          sed -i -E "s/^version: .*/version: ${VER}/" Chart.yaml
          if grep -q '^appVersion:' Chart.yaml; then
            sed -i -E "s/^appVersion: .*/appVersion: ${VER}/" Chart.yaml
          fi
          echo "Updated Chart.yaml:"
          grep -E '^(version|appVersion):' Chart.yaml

  # release:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Configure AWS Management Credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-region: ${{ vars.AWS_DEFAULT_REGION }}
  #         role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}


  #     - name: Add datafyio-s3 Helm repository
  #       run: |
  #         helm plugin install https://github.com/hypnoglow/helm-s3.git
  #         helm repo add datafyio-s3 s3://helm.datafy.io/datafy-agent

  #     - name: Update Helm dependency
  #       run: |
  #         helm dependency update

  #     - name: Push Helm chart
  #       run: |
  #         CHART_VERSION=$(yq '.version' Chart.yaml)
  #         EBS_CSI_DRIVER_VERSION=$(yq '.dependencies[] | select(.name == "aws-ebs-csi-driver") | .version' Chart.yaml)
  #         helm package --version "${CHART_VERSION}+ebscsi.${EBS_CSI_DRIVER_VERSION}" .
  #         helm s3 push datafy-agent-*.tgz datafyio-s3 --relative

