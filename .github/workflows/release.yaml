name: Release Chart

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      PRODUCTION_AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: write  # Grant write access to the repository contents

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configure AWS Management Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}

      - name: Add datafyio-s3 Helm repository
        run: |
          helm plugin install https://github.com/hypnoglow/helm-s3.git
          helm repo add datafyio-s3 s3://helm.datafy.io/datafy-agent
      - name: Update Helm dependency
        run: |
          helm dependency update

      - name: Push Helm chart
        run: |
          CHART_VERSION=$(yq '.version' Chart.yaml)
          EBS_CSI_DRIVER_VERSION=$(yq '.dependencies[] | select(.name == "aws-ebs-csi-driver") | .version' Chart.yaml)
          echo "ðŸ“¦ Packaging base chart..."
          helm package --version "${CHART_VERSION}" .
          helm s3 push "datafy-agent-${CHART_VERSION}.tgz" datafyio-s3 --relative

  upload-scripts:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Management Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}

      - name: Extract versions and upload scripts to S3
        run: |
          CHART_VERSION=$(yq '.version' Chart.yaml)
          APP_VERSION=$(yq '.appVersion' Chart.yaml)
          AGENT_VERSION=$(echo "${APP_VERSION}" | cut -d'_' -f1)
                    
          sed -i "s/^CHART_VERSION=.*/CHART_VERSION=\"${CHART_VERSION}\"/" scripts/datafy-agent-install-k8s.sh
          
          grep "^CHART_VERSION=" scripts/datafy-agent-install-k8s.sh
          
          S3_BUCKET="agent.datafy.io"
          S3_PATH="s3://${S3_BUCKET}/agent/${AGENT_VERSION}/"
          
          aws s3 cp scripts/datafy-agent-install-k8s.sh "${S3_PATH}datafy-agent-install-k8s.sh"
          aws s3 cp scripts/datafy-agent-uninstall-k8s.sh "${S3_PATH}datafy-agent-uninstall-k8s.sh"
          