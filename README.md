# datafy-agent

![Version: 1.4.3](https://img.shields.io/badge/Version-1.4.3-informational?style=flat-square)

This guide explains how to add the Datafy Helm repo and install the `datafy-agent`.

---

## Features
- Dual mode: sensor / autoscaler
- Optional bundled aws-ebs-csi-driver
- CSI proxy support
- Configurable env, resources, tolerations, affinity
- Pluggable token secret
- Validations (CSI presence, mode logic)
- Autogenerated values documentation (helm-docs)

---

## Dependencies
The chart can optionally install the AWS EBS CSI driver.
Set `awsEbsCsiDriver.enabled=true` to deploy it, or `false` to use an existing install.

## Requirements

| Repository | Name | Version |
|------------|------|---------|
| https://kubernetes-sigs.github.io/aws-ebs-csi-driver | aws-ebs-csi-driver | 2.45.1 |

---

## Quick Start (Sensor)
```bash
helm repo add datafyio https://helm.datafy.io/datafy-agent
helm repo update
helm upgrade --install datafy-agent datafyio/datafy-agent \
  --namespace datafy --create-namespace \
  --set agent.mode="sensor" \
  --set agent.token=$DATAFY_TOKEN
```

## Quick Start (Autoscaler + Existing CSI)
```bash
helm upgrade --install datafy-agent datafyio/datafy-agent \
  -n datafy --create-namespace \
  --set agent.mode="autoscaler" \
  --set agent.token=$DATAFY_TOKEN \
```

## Modes Matrix
| agent.mode | Core sidecar | Needs CSI Driver | Uses CSI Proxy | Notes |
|-----------|--------------|------------------|----------------|-------|
| sensor    | No           | No               | No             | Minimal footprint |
| autoscaler| Yes (core)   | Recommended      | Optional       | Scaling logic enabled |

---

## Installation Guide
### 1. Add Repo
```bash
helm repo add datafyio https://helm.datafy.io/datafy-agent
helm repo update
```

### 2. Install
```bash
helm upgrade --install datafy-agent datafyio/datafy-agent --namespace <namespace> --create-namespace \
  --set agent.mode="sensor/autoscaler" \
  --set agent.token=<your_token> \
  --set agent.image.tag=<image_tag>
```

### 3. Enable / Disable aws-ebs-csi-driver
```bash
helm upgrade --install datafy-agent datafyio/datafy-agent \
  --set awsEbsCsiDriver.enabled=true
```

Override subchart values:
```yaml
aws-ebs-csi-driver:
  controller:
    replicaCount: 2
```

### 4. Optional Customizations
```yaml
agent:
  mode: autoscaler
  env:
    LOG_LEVEL: info
image:
  imagePullSecrets:
    - myRegistrySecret
ebsCsiProxy:
  namespace: kube-system
```

### 5. Verify
```bash
kubectl get pods -n <namespace> -l app.kubernetes.io/instance=datafy-agent
```

---

## Upgrade
```bash
helm repo update
helm upgrade --install datafy-agent datafyio/datafy-agent -n <namespace> --reuse-values
```
Switch mode:
```bash
helm upgrade --install datafy-agent datafyio/datafy-agent -n <namespace>--set agent.mode=autoscaler
```
Rollback:
```bash
helm rollback datafy-agent 1 -n <ns>
```

---

## Uninstall
```bash
helm uninstall datafy-agent --namespace <namespace>
```

---

## Highlighted Values
| Key | Description | Example |
|-----|-------------|---------|
| agent.mode | Deployment mode | autoscaler |
| agent.token | Auth token | abc123 |
| awsEbsCsiDriver.enabled | Install bundled driver | true |
| ebsCsiProxy.enabled | Use proxy with existing driver | true |
| agent.env | Extra env vars | LOG_LEVEL=info |
| agent.image.tag | Image tag override | v1.2.3 |

---

## Troubleshooting
| Symptom | Cause | Resolution |
|---------|-------|-----------|
| CSI validation failure | Driver missing | Install driver or disable proxy |
| Pods Pending | Taints | Add tolerations |
| CrashLoop (token) | Secret missing | Create secret or set agent.token |
| Mode switch not applied | Old pods | Rollout restart / upgrade |

---

## Security Recommendations
- runAsNonRoot, drop ALL capabilities
- readOnlyRootFilesystem=true
- Limit hostNetwork / hostPID
- Scope token secret
- Use imagePullSecrets for private registries

---

## Development
```bash
helm lint .
helm template test .
helm-docs
```

---

## Parameters
## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| agent.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key | string | `"eks.amazonaws.com/compute-type"` |  |
| agent.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].operator | string | `"NotIn"` |  |
| agent.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] | string | `"fargate"` |  |
| agent.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[1] | string | `"auto"` |  |
| agent.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[2] | string | `"hybrid"` |  |
| agent.coreMockEnabled | bool | `false` |  |
| agent.dsoUrl | string | `"wss://dso.datafy.io"` |  |
| agent.env | object | `{}` |  |
| agent.externalTokenSecret.key | string | `nil` |  |
| agent.externalTokenSecret.name | string | `nil` |  |
| agent.hqMockEnabled | bool | `false` |  |
| agent.image.imagePullSecrets | list | `[]` |  |
| agent.image.pullPolicy | string | `"Always"` |  |
| agent.image.repository | string | `"public.ecr.aws/datafy-io/datafy-agent"` |  |
| agent.image.tag | string | `"latest"` |  |
| agent.mode | string | `"AutoScaler"` |  |
| agent.nodeSelector | object | `{}` |  |
| agent.securityContext.privileged | bool | `true` |  |
| agent.securityContext.runAsGroup | int | `1000` |  |
| agent.securityContext.runAsUser | int | `1000` |  |
| agent.token | string | `nil` |  |
| agent.tolerations[0].operator | string | `"Exists"` |  |
| awsEbsCsiDriver.enabled | bool | `false` |  |
| ebsCsiProxy.enabled | bool | `true` |  |
| ebsCsiProxy.image.pullPolicy | string | `"IfNotPresent"` |  |
| ebsCsiProxy.image.repository | string | `"public.ecr.aws/datafy-io/ebs-csi-controller"` |  |
| ebsCsiProxy.image.tag | string | `"latest"` |  |
| ebsCsiProxy.namespace | string | `nil` |  |
| extraAnnotations | object | `{}` |  |
| extraLabels | object | `{}` |  |

## Notes
Generated by helm-docs. Do not edit Parameters manually.

---
_This README is rendered from README.md.gotmpl via helm-docs._
